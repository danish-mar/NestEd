{% extends "base_teacher.html" %}
#half page
{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Assign Marks</h1>
        <a href="/teacher/students" class="bg-gray-200 text-gray-700 py-2 px-4 rounded hover:bg-gray-300">
            <i class="fa-solid fa-arrow-left mr-2"></i>Back to Students
        </a>
    </div>

    <!-- Improved Student Search Section -->
    <div id="student-search-section" class="mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
                <label for="student-search" class="block text-sm font-medium text-gray-700 mb-1">Search Student</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="student-search" placeholder="Search by name, ID or email..."
                           class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="w-full md:w-1/3">
                <label for="student-select" class="block text-sm font-medium text-gray-700 mb-1">Quick Select</label>
                <select id="student-select" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Select a student --</option>
                    <!-- Students will be loaded here -->
                </select>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="mt-4 hidden">
            <h3 class="text-sm font-medium text-gray-700 mb-2">Search Results</h3>
            <div id="search-results-container" class="max-h-60 overflow-y-auto border rounded-lg">
                <!-- Search results will be displayed here -->
            </div>
        </div>
    </div>

    <div id="student-info" class="p-4 bg-blue-50 rounded-lg mb-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-600">Student Name</p>
                <p id="student-name" class="font-semibold"></p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Student ID</p>
                <p id="student-id" class="font-semibold"></p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Email</p>
                <p id="student-email" class="font-semibold"></p>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div id="marks-tabs-container" class="hidden mb-6">
        <div class="border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                <li class="mr-2">
                    <a href="#tab-manual" class="tab-link inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 active" data-tab="manual">Manual Marks</a>
                </li>
                <li class="mr-2">
                    <a href="#tab-practical" class="tab-link inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="practical">Practical Exam</a>
                </li>
                <li class="mr-2">
                    <a href="#tab-classtest" class="tab-link inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="classtest">Class Tests</a>
                </li>
                <li class="mr-2">
                    <a href="#tab-sla" class="tab-link inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="sla">SLA Activities</a>
                </li>
                <li class="mr-2">
                    <a href="#tab-summary" class="tab-link inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="summary">Summary</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Marks Form Container -->
    <div id="tab-content-container" class="hidden">
        <!-- 1. Manual Marks Tab Content -->
        <div id="tab-manual" class="tab-content">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Manual Marks (Experiments)</h2>
                    <div id="subject-info" class="bg-green-50 rounded-lg py-1 px-3">
                        <span class="text-sm text-gray-600 mr-1">Subject:</span>
                        <span id="teacher-subject" class="font-semibold">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600 text-sm mb-2">Record experiment marks for individual practical sessions.</p>
                </div>

                <!-- Existing Experiments Table -->
                <div id="existing-experiments" class="mb-6">
                    <h3 class="text-md font-medium text-gray-700 mb-2">Recorded Experiments</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 text-left">Experiment #</th>
                                <th class="py-2 px-4 text-left">Marks</th>
                                <th class="py-2 px-4 text-right">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="manual-marks-tbody">
                            <tr>
                                <td colspan="3" class="py-4 text-center text-gray-500">No experiment marks recorded yet</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-right">
                        <p class="text-sm text-gray-600">Average: <span id="manual-marks-average" class="font-semibold">0.0</span></p>
                    </div>
                </div>

                <!-- Add New Experiment Form -->
                <form id="manual-marks-form" class="border-t pt-4">
                    <h3 class="text-md font-medium text-gray-700 mb-3">Add New Experiment</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="experiment-number" class="block text-sm font-medium text-gray-700 mb-1">Experiment Number</label>
                            <input type="number" id="experiment-number" min="1" max="32" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="experiment-marks" class="block text-sm font-medium text-gray-700 mb-1">Marks Obtained</label>
                            <div class="flex items-center">
                                <input type="number" id="experiment-marks" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="experiment-marks">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="experiment-marks">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Mark Buttons -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Mark Buttons</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="70">70</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="75">75</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="80">80</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="85">85</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="90">90</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="95">95</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="experiment-marks" data-value="100">100</button>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fa-solid fa-plus mr-2"></i>Add Experiment
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. Practical Exam Tab Content -->
        <div id="tab-practical" class="tab-content hidden">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Practical Exam Marks</h2>
                    <div class="bg-green-50 rounded-lg py-1 px-3">
                        <span class="text-sm text-gray-600 mr-1">Subject:</span>
                        <span id="teacher-subject-practical" class="font-semibold">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600 text-sm mb-2">Record marks for the final practical examination.</p>
                </div>

                <!-- Practical Marks Status -->
                <div id="practical-marks-status" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fa-solid fa-info-circle text-blue-500 mr-2"></i>
                        <span id="practical-status-message">No practical exam marks recorded yet</span>
                    </div>
                </div>

                <!-- Practical Exam Form -->
                <form id="practical-marks-form">
                    <div class="mb-4">
                        <label for="practical-exam-marks" class="block text-sm font-medium text-gray-700 mb-1">Practical Exam Marks</label>
                        <div class="flex items-center">
                            <input type="number" id="practical-exam-marks" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <div class="ml-2 flex flex-col">
                                <button type="button" class="mark-increment" data-input="practical-exam-marks">
                                    <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                </button>
                                <button type="button" class="mark-decrement" data-input="practical-exam-marks">
                                    <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Mark Buttons -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Mark Buttons</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="70">70</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="75">75</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="80">80</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="85">85</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="90">90</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="95">95</button>
                            <button type="button" class="quick-mark bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200" data-input="practical-exam-marks" data-value="100">100</button>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="submit" id="practical-marks-submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Save Marks
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 3. Class Test Tab Content -->
        <div id="tab-classtest" class="tab-content hidden">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Class Test Marks</h2>
                    <div class="bg-green-50 rounded-lg py-1 px-3">
                        <span class="text-sm text-gray-600 mr-1">Subject:</span>
                        <span id="teacher-subject-classtest" class="font-semibold">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600 text-sm mb-2">Record marks for Class Test 1 and Class Test 2.</p>
                </div>

                <!-- Class Test Marks Status -->
                <div id="classtest-marks-status" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fa-solid fa-info-circle text-blue-500 mr-2"></i>
                        <span id="classtest-status-message">No class test marks recorded yet</span>
                    </div>
                </div>

                <!-- Class Test Form -->
                <form id="classtest-marks-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="class-test-1" class="block text-sm font-medium text-gray-700 mb-1">Class Test 1</label>
                            <div class="flex items-center">
                                <input type="number" id="class-test-1" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="class-test-1">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="class-test-1">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="class-test-2" class="block text-sm font-medium text-gray-700 mb-1">Class Test 2</label>
                            <div class="flex items-center">
                                <input type="number" id="class-test-2" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="class-test-2">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="class-test-2">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Average Display -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600">Average: <span id="classtest-average" class="font-semibold">0.0</span></p>
                    </div>

                    <!-- Quick Mark Buttons -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quick Mark Buttons</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="quick-mark-both bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200" data-value="70">Both 70</button>
                            <button type="button" class="quick-mark-both bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200" data-value="80">Both 80</button>
                            <button type="button" class="quick-mark-both bg-green-100 text-green-800 px-3 py-1 rounded hover:bg-green-200" data-value="90">Both 90</button>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="submit" id="classtest-marks-submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Save Marks
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 4. SLA Activities Tab Content -->
        <div id="tab-sla" class="tab-content hidden">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">SLA Activity Marks</h2>
                    <div class="bg-green-50 rounded-lg py-1 px-3">
                        <span class="text-sm text-gray-600 mr-1">Subject:</span>
                        <span id="teacher-subject-sla" class="font-semibold">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600 text-sm mb-2">Record marks for Micro Projects, Assignments and Other activities.</p>
                </div>

                <!-- SLA Marks Status -->
                <div id="sla-marks-status" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fa-solid fa-info-circle text-blue-500 mr-2"></i>
                        <span id="sla-status-message">No SLA activity marks recorded yet</span>
                    </div>
                </div>

                <!-- SLA Form -->
                <form id="sla-marks-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="micro-project" class="block text-sm font-medium text-gray-700 mb-1">Micro Project</label>
                            <div class="flex items-center">
                                <input type="number" id="micro-project" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="micro-project">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="micro-project">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="assignment" class="block text-sm font-medium text-gray-700 mb-1">Assignment</label>
                            <div class="flex items-center">
                                <input type="number" id="assignment" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="assignment">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="assignment">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="other-marks" class="block text-sm font-medium text-gray-700 mb-1">Other Marks</label>
                            <div class="flex items-center">
                                <input type="number" id="other-marks" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <div class="ml-2 flex flex-col">
                                    <button type="button" class="mark-increment" data-input="other-marks">
                                        <i class="fa-solid fa-chevron-up text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                    <button type="button" class="mark-decrement" data-input="other-marks">
                                        <i class="fa-solid fa-chevron-down text-gray-500 hover:text-blue-500"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="submit" id="sla-marks-submit" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Save Marks
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 5. Summary Tab Content -->
        <div id="tab-summary" class="tab-content hidden">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Marks Summary</h2>
                    <div class="bg-green-50 rounded-lg py-1 px-3">
                        <span class="text-sm text-gray-600 mr-1">Subject:</span>
                        <span id="teacher-subject-summary" class="font-semibold">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600 text-sm mb-2">Complete overview of all student marks.</p>
                </div>

                <!-- Summary Content -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Manual Marks Summary -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Manual Marks (Experiments)</h3>
                        <div id="manual-marks-summary" class="text-sm">
                            <p>Total Experiments: <span id="total-experiments" class="font-semibold">0</span></p>
                            <p>Average Score: <span id="summary-manual-average" class="font-semibold">N/A</span></p>
                        </div>
                    </div>

                    <!-- Practical Exam Summary -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Practical Exam</h3>
                        <div id="practical-marks-summary" class="text-sm">
                            <p>Status: <span id="practical-exam-status" class="font-semibold">Not Recorded</span></p>
                            <p>Marks: <span id="practical-exam-score" class="font-semibold">N/A</span></p>
                        </div>
                    </div>

                    <!-- Class Test Summary -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-md font-medium text-gray-700 mb-2">Class Tests</h3>
                        <div id="classtest-marks-summary" class="text-sm">
                            <p>Status: <span id="classtest-status" class="font-semibold">Not Recorded</span></p>
                            <p>Class Test 1: <span id="summary-test1" class="font-semibold">N/A</span></p>
                            <p>Class Test 2: <span id="summary-test2" class="font-semibold">N/A</span></p>
                            <p>Average: <span id="summary-test-avg" class="font-semibold">N/A</span></p>
                        </div>
                    </div>

                    <!-- SLA Activities Summary -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200">
                        <h3 class="text-md font-medium text-gray-700 mb-2">SLA Activities</h3>
                        <div id="sla-marks-summary" class="text-sm">
                            <p>Status: <span id="sla-status" class="font-semibold">Not Recorded</span></p>
                            <p>Micro Project: <span id="summary-micro-project" class="font-semibold">N/A</span></p>
                            <p>Assignment: <span id="summary-assignment" class="font-semibold">N/A</span></p>
                            <p>Other Marks: <span id="summary-other-marks" class="font-semibold">N/A</span></p>
                        </div>
                    </div>
                </div>

                <!-- Final Score -->
                <div class="mt-6 p-4 bg-blue-100 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Final Score</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p>Total Components Recorded: <span id="components-recorded" class="font-semibold">0/4</span></p>
                            <p>Average Score: <span id="overall-average" class="font-semibold">N/A</span></p>
                        </div>
                        <div class="text-right">
                            <button id="calculate-final-score" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                <i class="fa-solid fa-calculator mr-2"></i>Calculate Final Score
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4"></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global variables to track current student
        let currentStudent = null;
        let teacherSubject = null;

        // Get teacher details and subject
        fetchTeacherDetails();

        // Initialize student search functionality
        initializeStudentSearch();

        // Initialize tabs
        initializeTabs();

        // Initialize mark incrementers and decrementers
        initializeMarkButtons();

        // Initialize form submissions
        initializeFormSubmissions();

        // Initialize the quick mark buttons
        initializeQuickMarkButtons();

        // Show notification toast
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-3 mb-2 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} shadow-lg animate-fade-in`;
            toast.innerHTML = `<div class="flex items-center">
            <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
            <span>${message}</span>
        </div>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toastContainer.removeChild(toast), 500);
            }, 3000);
        }

        // Fetch teacher details
        function fetchTeacherDetails() {
            fetch('/api/teacher/details')
                .then(response => response.json())
                .then(data => {
                    if (data.subject) {
                        teacherSubject = data.subject;
                        document.getElementById('teacher-subject').textContent = teacherSubject.subject_name;
                        document.getElementById('teacher-subject-practical').textContent = teacherSubject.subject_name;
                        document.getElementById('teacher-subject-classtest').textContent = teacherSubject.subject_name;
                        document.getElementById('teacher-subject-sla').textContent = teacherSubject.subject_name;
                        document.getElementById('teacher-subject-summary').textContent = teacherSubject.subject_name;
                    }
                })
                .catch(error => {
                    console.error('Error fetching teacher details:', error);
                    showToast('Failed to load teacher details', 'error');
                });
        }

        // Initialize student search
        function initializeStudentSearch() {
            const searchInput = document.getElementById('student-search');
            const studentSelect = document.getElementById('student-select');
            const searchResults = document.getElementById('search-results');
            const searchResultsContainer = document.getElementById('search-results-container');

            // Search input event listener
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length < 2) {
                    searchResults.classList.add('hidden');
                    return;
                }

                fetch('/api/teacher/students')
                    .then(response => response.json())
                    .then(students => {
                        const filteredStudents = students.filter(student =>
                            student.name.toLowerCase().includes(query.toLowerCase()) ||
                            student.email.toLowerCase().includes(query.toLowerCase()) ||
                            student.student_id.toString().includes(query)
                        );

                        if (filteredStudents.length > 0) {
                            searchResultsContainer.innerHTML = '';
                            filteredStudents.forEach(student => {
                                const studentEl = document.createElement('div');
                                studentEl.className = 'p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                                studentEl.innerHTML = `
                                <div>
                                    <div class="font-medium">${student.name}</div>
                                    <div class="text-xs text-gray-500">${student.email}</div>
                                </div>
                                <div class="text-sm text-gray-600">ID: ${student.student_id}</div>
                            `;
                                studentEl.addEventListener('click', () => {
                                    loadStudent(student);
                                    searchResults.classList.add('hidden');
                                    searchInput.value = '';
                                });
                                searchResultsContainer.appendChild(studentEl);
                            });
                            searchResults.classList.remove('hidden');
                        } else {
                            searchResultsContainer.innerHTML = '<div class="p-2 text-gray-500">No students found</div>';
                            searchResults.classList.remove('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error searching students:', error);
                        showToast('Failed to search students', 'error');
                    });
            });

            // Quick select dropdown
            fetch('/api/teacher/students')
                .then(response => response.json())
                .then(students => {
                    studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.student_id;
                        option.textContent = `${student.name} (ID: ${student.student_id})`;
                        studentSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    showToast('Failed to load students', 'error');
                });

            studentSelect.addEventListener('change', function() {
                if (this.value) {
                    fetch('/api/teacher/students')
                        .then(response => response.json())
                        .then(students => {
                            const student = students.find(s => s.student_id == this.value);
                            if (student) {
                                loadStudent(student);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading student:', error);
                            showToast('Failed to load student details', 'error');
                        });
                }
            });
        }

        // Load student data
        function loadStudent(student) {
            currentStudent = student;

            // Update student info display
            document.getElementById('student-info').classList.remove('hidden');
            document.getElementById('student-name').textContent = student.name;
            document.getElementById('student-id').textContent = student.student_id;
            document.getElementById('student-email').textContent = student.email;

            // Show the tabs and content container
            document.getElementById('marks-tabs-container').classList.remove('hidden');
            document.getElementById('tab-content-container').classList.remove('hidden');

            // Load all mark types
            loadManualMarks(student.student_id);
            loadPracticalExamMarks(student.student_id);
            loadClassTestMarks(student.student_id);
            loadSLAMarks(student.student_id);

            // Update summary tab
            updateSummaryTab();
        }

        // Load Manual Marks
        function loadManualMarks(studentId) {
            fetch(`/api/teacher/students/${studentId}/manual_marks`)
                .then(response => {
                    if (!response.ok && response.status !== 404) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(marks => {
                    const tbody = document.getElementById('manual-marks-tbody');

                    if (!Array.isArray(marks) || marks.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500">No experiment marks recorded yet</td></tr>';
                        document.getElementById('manual-marks-average').textContent = '0.0';
                        return;
                    }

                    tbody.innerHTML = '';
                    let totalMarks = 0;

                    marks.forEach(mark => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td class="py-2 px-4 border-b">${mark.experiment_number}</td>
                        <td class="py-2 px-4 border-b">${mark.marks_obtained}</td>
                        <td class="py-2 px-4 border-b text-right">
                            <button class="text-blue-500 hover:text-blue-700 mr-2 edit-manual-mark" data-id="${mark.manual_marks_id}" data-experiment="${mark.experiment_number}" data-marks="${mark.marks_obtained}">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700 delete-manual-mark" data-id="${mark.manual_marks_id}">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                        tbody.appendChild(row);
                        totalMarks += mark.marks_obtained;
                    });

                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('.edit-manual-mark').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const experiment = this.getAttribute('data-experiment');
                            const marks = this.getAttribute('data-marks');

                            document.getElementById('experiment-number').value = experiment;
                            document.getElementById('experiment-marks').value = marks;

                            // Change the form submission to update mode
                            const form = document.getElementById('manual-marks-form');
                            form.dataset.mode = 'update';
                            form.dataset.markId = id;

                            // Change the button text
                            form.querySelector('button[type="submit"]').innerHTML = '<i class="fa-solid fa-save mr-2"></i>Update Experiment';
                        });
                    });

                    document.querySelectorAll('.delete-manual-mark').forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (confirm('Are you sure you want to delete this experiment mark?')) {
                                const id = this.getAttribute('data-id');
                                deleteManualMark(id);
                            }
                        });
                    });

                    // Update the average
                    const average = marks.length > 0 ? (totalMarks / marks.length).toFixed(1) : '0.0';
                    document.getElementById('manual-marks-average').textContent = average;
                })
                .catch(error => {
                    console.error('Error loading manual marks:', error);
                    showToast('Failed to load experiment marks', 'error');
                });
        }

        // Delete Manual Mark
        function deleteManualMark(markId) {
            fetch(`/api/teacher/manual_marks/${markId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Experiment mark deleted successfully');
                        loadManualMarks(currentStudent.student_id);
                        updateSummaryTab();
                    } else {
                        showToast(data.error || 'Failed to delete mark', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting manual mark:', error);
                    showToast('Failed to delete experiment mark', 'error');
                });
        }

        // Load Practical Exam Marks
        function loadPracticalExamMarks(studentId) {
            fetch(`/api/teacher/students/${studentId}/practical_marks`)
                .then(response => {
                    if (!response.ok && response.status !== 404) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const statusMessage = document.getElementById('practical-status-message');
                    const form = document.getElementById('practical-marks-form');

                    if (data.error || !data.practical_marks_id) {
                        statusMessage.innerHTML = '<span class="text-yellow-600">No practical exam marks recorded yet</span>';
                        document.getElementById('practical-exam-marks').value = '';
                        form.dataset.mode = 'create';
                        form.dataset.markId = '';
                    } else {
                        statusMessage.innerHTML = `<span class="text-green-600">Marks recorded: ${data.practical_exam_marks}</span>`;
                        document.getElementById('practical-exam-marks').value = data.practical_exam_marks;
                        form.dataset.mode = 'update';
                        form.dataset.markId = data.practical_marks_id;
                    }
                })
                .catch(error => {
                    console.error('Error loading practical exam marks:', error);
                    const statusMessage = document.getElementById('practical-status-message');
                    statusMessage.innerHTML = '<span class="text-yellow-600">No practical exam marks recorded yet</span>';
                    document.getElementById('practical-exam-marks').value = '';
                    document.getElementById('practical-marks-form').dataset.mode = 'create';
                });
        }

        // Load Class Test Marks
        function loadClassTestMarks(studentId) {
            fetch(`/api/teacher/students/${studentId}/class_test_marks`)
                .then(response => {
                    if (!response.ok && response.status !== 404) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const statusMessage = document.getElementById('classtest-status-message');
                    const form = document.getElementById('classtest-marks-form');

                    if (data.error || !data.class_test_marks_id) {
                        statusMessage.innerHTML = '<span class="text-yellow-600">No class test marks recorded yet</span>';
                        document.getElementById('class-test-1').value = '';
                        document.getElementById('class-test-2').value = '';
                        document.getElementById('classtest-average').textContent = '0.0';
                        form.dataset.mode = 'create';
                        form.dataset.markId = '';
                    } else {
                        statusMessage.innerHTML = `<span class="text-green-600">Marks recorded</span>`;
                        document.getElementById('class-test-1').value = data.class_test_1;
                        document.getElementById('class-test-2').value = data.class_test_2;
                        document.getElementById('classtest-average').textContent = data.average_marks.toFixed(1);
                        form.dataset.mode = 'update';
                        form.dataset.markId = data.class_test_marks_id;
                    }
                })
                .catch(error => {
                    console.error('Error loading class test marks:', error);
                    const statusMessage = document.getElementById('classtest-status-message');
                    statusMessage.innerHTML = '<span class="text-yellow-600">No class test marks recorded yet</span>';
                    document.getElementById('class-test-1').value = '';
                    document.getElementById('class-test-2').value = '';
                    document.getElementById('classtest-average').textContent = '0.0';
                    document.getElementById('classtest-marks-form').dataset.mode = 'create';
                });
        }

// Load SLA Marks
        function loadSLAMarks(studentId) {
            fetch(`/api/teacher/students/${studentId}/sla_marks`)
                .then(response => {
                    if (!response.ok && response.status !== 404) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const statusMessage = document.getElementById('sla-status-message');
                    const form = document.getElementById('sla-marks-form');

                    if (data.error || !data.sla_marks_id) {
                        statusMessage.innerHTML = '<span class="text-yellow-600">No SLA activity marks recorded yet</span>';
                        document.getElementById('micro-project').value = '';
                        document.getElementById('assignment').value = '';
                        document.getElementById('other-marks').value = '';
                        form.dataset.mode = 'create';
                        form.dataset.markId = '';
                    } else {
                        statusMessage.innerHTML = `<span class="text-green-600">Marks recorded</span>`;
                        document.getElementById('micro-project').value = data.micro_project;
                        document.getElementById('assignment').value = data.assignment;
                        document.getElementById('other-marks').value = data.other_marks;
                        form.dataset.mode = 'update';
                        form.dataset.markId = data.sla_marks_id;
                    }
                })
                .catch(error => {
                    console.error('Error loading SLA marks:', error);
                    const statusMessage = document.getElementById('sla-status-message');
                    statusMessage.innerHTML = '<span class="text-yellow-600">No SLA activity marks recorded yet</span>';
                    document.getElementById('micro-project').value = '';
                    document.getElementById('assignment').value = '';
                    document.getElementById('other-marks').value = '';
                    document.getElementById('sla-marks-form').dataset.mode = 'create';
                });
        }

// Update Summary Tab
        function updateSummaryTab() {
            const studentId = currentStudent.student_id;

            // Manual Marks Summary
            fetch(`/api/teacher/students/${studentId}/manual_marks`)
                .then(response => response.json())
                .then(data => {
                    const totalExperiments = Array.isArray(data) ? data.length : 0;
                    const totalMarks = Array.isArray(data) ? data.reduce((sum, mark) => sum + mark.marks_obtained, 0) : 0;
                    const average = totalExperiments > 0 ? (totalMarks / totalExperiments).toFixed(1) : 'N/A';

                    document.getElementById('total-experiments').textContent = totalExperiments;
                    document.getElementById('summary-manual-average').textContent = average;
                })
                .catch(() => {
                    document.getElementById('total-experiments').textContent = '0';
                    document.getElementById('summary-manual-average').textContent = 'N/A';
                });

            // Practical Exam Summary
            fetch(`/api/teacher/students/${studentId}/practical_marks`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.practical_marks_id) {
                        document.getElementById('practical-exam-status').textContent = 'Not Recorded';
                        document.getElementById('practical-exam-score').textContent = 'N/A';
                    } else {
                        document.getElementById('practical-exam-status').textContent = 'Recorded';
                        document.getElementById('practical-exam-score').textContent = data.practical_exam_marks;
                    }
                })
                .catch(() => {
                    document.getElementById('practical-exam-status').textContent = 'Not Recorded';
                    document.getElementById('practical-exam-score').textContent = 'N/A';
                });

            // Class Test Summary
            fetch(`/api/teacher/students/${studentId}/class_test_marks`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.class_test_marks_id) {
                        document.getElementById('classtest-status').textContent = 'Not Recorded';
                        document.getElementById('summary-test1').textContent = 'N/A';
                        document.getElementById('summary-test2').textContent = 'N/A';
                        document.getElementById('summary-test-avg').textContent = 'N/A';
                    } else {
                        document.getElementById('classtest-status').textContent = 'Recorded';
                        document.getElementById('summary-test1').textContent = data.class_test_1;
                        document.getElementById('summary-test2').textContent = data.class_test_2;
                        document.getElementById('summary-test-avg').textContent = data.average_marks.toFixed(1);
                    }
                })
                .catch(() => {
                    document.getElementById('classtest-status').textContent = 'Not Recorded';
                    document.getElementById('summary-test1').textContent = 'N/A';
                    document.getElementById('summary-test2').textContent = 'N/A';
                    document.getElementById('summary-test-avg').textContent = 'N/A';
                });

            // SLA Activities Summary
            fetch(`/api/teacher/students/${studentId}/sla_marks`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || !data.sla_marks_id) {
                        document.getElementById('sla-status').textContent = 'Not Recorded';
                        document.getElementById('summary-micro-project').textContent = 'N/A';
                        document.getElementById('summary-assignment').textContent = 'N/A';
                        document.getElementById('summary-other-marks').textContent = 'N/A';
                    } else {
                        document.getElementById('sla-status').textContent = 'Recorded';
                        document.getElementById('summary-micro-project').textContent = data.micro_project;
                        document.getElementById('summary-assignment').textContent = data.assignment;
                        document.getElementById('summary-other-marks').textContent = data.other_marks;
                    }
                })
                .catch(() => {
                    document.getElementById('sla-status').textContent = 'Not Recorded';
                    document.getElementById('summary-micro-project').textContent = 'N/A';
                    document.getElementById('summary-assignment').textContent = 'N/A';
                    document.getElementById('summary-other-marks').textContent = 'N/A';
                });

            // Calculate Final Score
            calculateFinalScore();
        }

// Calculate Final Score
        function calculateFinalScore() {
            const studentId = currentStudent.student_id;
            let componentsRecorded = 0;
            let totalAverage = 0;

            // Manual Marks
            fetch(`/api/teacher/students/${studentId}/manual_marks`)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        const totalMarks = data.reduce((sum, mark) => sum + mark.marks_obtained, 0);
                        totalAverage += totalMarks / data.length;
                        componentsRecorded++;
                    }
                })
                .finally(() => {
                    // Practical Exam Marks
                    fetch(`/api/teacher/students/${studentId}/practical_marks`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.practical_exam_marks) {
                                totalAverage += data.practical_exam_marks;
                                componentsRecorded++;
                            }
                        })
                        .finally(() => {
                            // Class Test Marks
                            fetch(`/api/teacher/students/${studentId}/class_test_marks`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.class_test_1 && data.class_test_2) {
                                        totalAverage += data.average_marks;
                                        componentsRecorded++;
                                    }
                                })
                                .finally(() => {
                                    // SLA Marks
                                    fetch(`/api/teacher/students/${studentId}/sla_marks`)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.micro_project || data.assignment || data.other_marks) {
                                                const slaAvg = (data.micro_project + data.assignment + data.other_marks) / 3;
                                                totalAverage += slaAvg;
                                                componentsRecorded++;
                                            }
                                        })
                                        .finally(() => {
                                            document.getElementById('components-recorded').textContent = `${componentsRecorded}/4`;
                                            document.getElementById('overall-average').textContent = componentsRecorded > 0 ? (totalAverage / componentsRecorded).toFixed(1) : 'N/A';
                                        });
                                });
                        });
                });
        }

// Initialize Tabs
        function initializeTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    tabLinks.forEach(l => l.classList.remove('border-blue-500', 'text-gray-800'));
                    tabContents.forEach(c => c.classList.add('hidden'));

                    this.classList.add('border-blue-500', 'text-gray-800');
                    document.getElementById(`tab-${this.dataset.tab}`).classList.remove('hidden');
                });
            });

            // Activate the first tab by default
            tabLinks[0].click();
        }

// Initialize Mark Buttons (Increment/Decrement)
        function initializeMarkButtons() {
            document.querySelectorAll('.mark-increment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputId = this.dataset.input;
                    const input = document.getElementById(inputId);
                    let value = parseFloat(input.value) || 0;
                    if (value < parseFloat(input.max)) {
                        input.value = (value + 0.5).toFixed(1);
                        if (inputId === 'class-test-1' || inputId === 'class-test-2') updateClassTestAverage();
                    }
                });
            });

            document.querySelectorAll('.mark-decrement').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputId = this.dataset.input;
                    const input = document.getElementById(inputId);
                    let value = parseFloat(input.value) || 0;
                    if (value > parseFloat(input.min)) {
                        input.value = (value - 0.5).toFixed(1);
                        if (inputId === 'class-test-1' || inputId === 'class-test-2') updateClassTestAverage();
                    }
                });
            });
        }

// Update Class Test Average
        function updateClassTestAverage() {
            const test1 = parseFloat(document.getElementById('class-test-1').value) || 0;
            const test2 = parseFloat(document.getElementById('class-test-2').value) || 0;
            const average = ((test1 + test2) / 2).toFixed(1);
            document.getElementById('classtest-average').textContent = average;
        }

// Initialize Quick Mark Buttons
        function initializeQuickMarkButtons() {
            document.querySelectorAll('.quick-mark').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputId = this.dataset.input;
                    const value = this.dataset.value;
                    document.getElementById(inputId).value = value;
                    if (inputId === 'class-test-1' || inputId === 'class-test-2') updateClassTestAverage();
                });
            });

            document.querySelectorAll('.quick-mark-both').forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = this.dataset.value;
                    document.getElementById('class-test-1').value = value;
                    document.getElementById('class-test-2').value = value;
                    updateClassTestAverage();
                });
            });
        }

// Initialize Form Submissions
        function initializeFormSubmissions() {
            // Manual Marks Form
            const manualForm = document.getElementById('manual-marks-form');
            manualForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const mode = this.dataset.mode || 'create';
                const markId = this.dataset.markId;
                const experimentNumber = document.getElementById('experiment-number').value;
                const marksObtained = document.getElementById('experiment-marks').value;

                const url = mode === 'create' ? `/api/teacher/students/${currentStudent.student_id}/manual_marks` : `/manual_marks/${markId}`;
                const method = mode === 'create' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ experiment_number: experimentNumber, marks_obtained: marksObtained })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(mode === 'create' ? 'Experiment added successfully' : 'Experiment updated successfully');
                            loadManualMarks(currentStudent.student_id);
                            updateSummaryTab();

                            // Reset form to add mode
                            this.reset();
                            this.dataset.mode = 'create';
                            this.dataset.markId = '';
                            this.querySelector('button[type="submit"]').innerHTML = '<i class="fa-solid fa-plus mr-2"></i>Add Experiment';
                        } else {
                            showToast(data.error || 'Failed to save experiment', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving manual marks:', error);
                        showToast('Failed to save experiment', 'error');
                    });
            });

            // Practical Marks Form
            const practicalForm = document.getElementById('practical-marks-form');
            practicalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const mode = this.dataset.mode || 'create';
                const markId = this.dataset.markId;
                const practicalMarks = document.getElementById('practical-exam-marks').value;

                const url = mode === 'create' ? `/api/teacher/students/${currentStudent.student_id}/practical_marks` : `/practical_marks/${markId}`;
                const method = mode === 'create' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ practical_exam_marks: practicalMarks })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(mode === 'create' ? 'Practical marks saved successfully' : 'Practical marks updated successfully');
                            loadPracticalExamMarks(currentStudent.student_id);
                            updateSummaryTab();
                        } else {
                            showToast(data.error || 'Failed to save practical marks', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving practical marks:', error);
                        showToast('Failed to save practical marks', 'error');
                    });
            });

            // Class Test Marks Form
            const classTestForm = document.getElementById('classtest-marks-form');
            classTestForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const mode = this.dataset.mode || 'create';
                const markId = this.dataset.markId;
                const classTest1 = document.getElementById('class-test-1').value;
                const classTest2 = document.getElementById('class-test-2').value;

                const url = mode === 'create' ? `/api/teacher/students/${currentStudent.student_id}/class_test_marks` : `/class_test_marks/${markId}`;
                const method = mode === 'create' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_test_1: classTest1, class_test_2: classTest2 })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(mode === 'create' ? 'Class test marks saved successfully' : 'Class test marks updated successfully');
                            loadClassTestMarks(currentStudent.student_id);
                            updateSummaryTab();
                        } else {
                            showToast(data.error || 'Failed to save class test marks', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving class test marks:', error);
                        showToast('Failed to save class test marks', 'error');
                    });
            });

            // SLA Marks Form
            const slaForm = document.getElementById('sla-marks-form');
            slaForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const mode = this.dataset.mode || 'create';
                const markId = this.dataset.markId;
                const microProject = document.getElementById('micro-project').value;
                const assignment = document.getElementById('assignment').value;
                const otherMarks = document.getElementById('other-marks').value;

                const url = mode === 'create' ? `/api/teacher/students/${currentStudent.student_id}/sla_marks` : `/sla_marks/${markId}`;
                const method = mode === 'create' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ micro_project: microProject, assignment: assignment, other_marks: otherMarks })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast(mode === 'create' ? 'SLA marks saved successfully' : 'SLA marks updated successfully');
                            loadSLAMarks(currentStudent.student_id);
                            updateSummaryTab();
                        } else {
                            showToast(data.error || 'Failed to save SLA marks', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving SLA marks:', error);
                        showToast('Failed to save SLA marks', 'error');
                    });
            });

            // Final Score Calculation Button
            document.getElementById('calculate-final-score').addEventListener('click', function() {
                calculateFinalScore();
                showToast('Final score recalculated');
            });
        }
    });
</script>
{% endblock %}